#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PATH="$SCRIPT_DIR:$PATH"

testhost=`hostname`
tacfile=`tacpath-flud`
if [ -z "$tacfile" ]; then
    tacfile="$SCRIPT_DIR/tacpath-flud"
    tacfile=$("$tacfile")
fi
if [ -z "$tacfile" ]; then
    echo "could not determine FludNode.tac path" >&2
    exit 1
fi
invoker="twistd -oy $tacfile"

if [ -z ${FLUDSTART} ]; then
    i=1
else
    i=${FLUDSTART}
fi

NODES=${1:-1}

if [ -n $3 ]; then
    boothost=$2
    bootport=$3
fi

export FLUDHOME="${HOME}/.flud${i}"
if [ ! -d $FLUDHOME ]; then
    mkdir $FLUDHOME;
fi
let listenport=8080+$i
pidfile="$FLUDHOME/twistd.pid"
logfile="$FLUDHOME/twistd.log"
if [ -n "$boothost" ]; then
    echo "starting {$FLUDHOME} $invoker on $listenport to $boothost:$bootport"
    FLUDGWHOST=$boothost FLUDGWPORT=$bootport FLUDPORT=$listenport $invoker --pidfile=$pidfile --logfile=$logfile
else
    echo "starting {$FLUDHOME} $invoker on $listenport"
    FLUDPORT=$listenport $invoker --pidfile=$pidfile --logfile=$logfile
fi
pids[$i]=$!

let seqstart=$i+1
let seqend=$NODES+$i-1

for i in `seq $seqstart $seqend`; do
    export FLUDHOME="${HOME}/.flud${i}"
    if [ ! -d $FLUDHOME ]; then
        mkdir $FLUDHOME;
    fi
    testport=$listenport
    let listenport=8080+$i
    pidfile="$FLUDHOME/twistd.pid"
    logfile="$FLUDHOME/twistd.log"
    echo "starting {$FLUDHOME} $invoker on $listenport to $testhost:$testport"
    FLUDGWHOST=$testhost FLUDGWPORT=$testport FLUDPORT=$listenport $invoker --pidfile=$pidfile --logfile=$logfile
    pids[$i]=$!
done
